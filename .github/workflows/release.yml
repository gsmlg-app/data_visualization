name: Release

on:
  workflow_dispatch:
    inputs:
      version_type:
        description: 'Version bump type'
        required: true
        default: 'patch'
        type: choice
        options:
          - patch
          - minor
          - major
      dry_run:
        description: 'Dry run (skip publish and GitHub release)'
        required: false
        default: false
        type: boolean

permissions:
  contents: write
  id-token: write

jobs:
  release:
    name: Release packages
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable

      - name: Setup Dart
        uses: dart-lang/setup-dart@v1

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.pub-cache
            .dart_tool
          key: ${{ runner.os }}-pub-${{ hashFiles('**/pubspec.lock') }}
          restore-keys: ${{ runner.os }}-pub-

      - name: Install Melos
        run: dart pub global activate melos

      - name: Bootstrap workspace
        run: melos bootstrap

      - name: Run tests
        run: melos run test

      - name: Run analysis
        run: melos run analyze

      - name: Calculate new version
        id: version
        run: |
          # Get current version from main package
          CURRENT_VERSION=$(grep "^version:" packages/data_visualization/pubspec.yaml | sed 's/version: //')
          echo "Current version: $CURRENT_VERSION"

          # Parse version components
          IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT_VERSION"

          # Bump version based on type
          case "${{ github.event.inputs.version_type }}" in
            major)
              MAJOR=$((MAJOR + 1))
              MINOR=0
              PATCH=0
              ;;
            minor)
              MINOR=$((MINOR + 1))
              PATCH=0
              ;;
            patch)
              PATCH=$((PATCH + 1))
              ;;
          esac

          NEW_VERSION="${MAJOR}.${MINOR}.${PATCH}"
          echo "New version: $NEW_VERSION"
          echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT

      - name: Sync all package versions
        run: |
          echo "Synchronizing all packages to version ${{ steps.version.outputs.version }}..."
          chmod +x scripts/sync_versions.dart
          dart scripts/sync_versions.dart ${{ steps.version.outputs.version }}

      - name: Verify synchronized versions
        run: |
          echo "Verifying all packages have the same version..."
          EXPECTED_VERSION="${{ steps.version.outputs.version }}"

          for pubspec in packages/*/pubspec.yaml; do
            PKG_VERSION=$(grep "^version:" "$pubspec" | sed 's/version: //')
            PKG_NAME=$(grep "^name:" "$pubspec" | sed 's/name: //')

            if [ "$PKG_VERSION" != "$EXPECTED_VERSION" ]; then
              echo "âŒ ERROR: $PKG_NAME has version $PKG_VERSION, expected $EXPECTED_VERSION"
              exit 1
            fi
            echo "âœ“ $PKG_NAME: $PKG_VERSION"
          done

          echo "âœ“ All packages synchronized to version $EXPECTED_VERSION"

      - name: Generate changelog
        id: changelog
        run: |
          # Create release notes from recent commits
          cat > RELEASE_NOTES.md << 'EOF'
          ## What's Changed

          EOF

          # Get commits since last tag
          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          if [ -n "$LAST_TAG" ]; then
            echo "Changes since $LAST_TAG:" >> RELEASE_NOTES.md
            echo "" >> RELEASE_NOTES.md
            git log ${LAST_TAG}..HEAD --pretty=format:"* %s (%h)" >> RELEASE_NOTES.md
          else
            echo "Initial release" >> RELEASE_NOTES.md
            echo "" >> RELEASE_NOTES.md
            git log --pretty=format:"* %s (%h)" --max-count=50 >> RELEASE_NOTES.md
          fi

          cat >> RELEASE_NOTES.md << 'EOF'

          ## Published Packages

          **All 36 packages published with synchronized version v${{ steps.version.outputs.version }}**

          - **data_visualization** - Umbrella package (includes all packages)
          - **35 individual packages** - Core utilities, scales, shapes, geographic, hierarchical, charts, and more

          See [README.md](https://github.com/gsmlg-app/data_visualization/blob/main/README.md) for full package list.

          ## Installation

          \`\`\`yaml
          dependencies:
            data_visualization: ^${{ steps.version.outputs.version }}
          \`\`\`

          Or install individual packages:

          \`\`\`yaml
          dependencies:
            dv_scale: ^${{ steps.version.outputs.version }}
            dv_curve: ^${{ steps.version.outputs.version }}
            dv_shape: ^${{ steps.version.outputs.version }}
          \`\`\`

          ## Resources

          - ðŸ“Š [Live Demo](https://gsmlg-app.github.io/data_visualization/)
          - ðŸ“– [Documentation](https://pub.dev/packages/data_visualization)
          - ðŸ’» [GitHub](https://github.com/gsmlg-app/data_visualization)
          EOF

          echo "Release notes generated:"
          cat RELEASE_NOTES.md

      - name: Commit version changes
        if: ${{ github.event.inputs.dry_run != 'true' }}
        run: |
          git add packages/*/pubspec.yaml
          git commit -m "chore(release): publish packages v${{ steps.version.outputs.version }}

          All packages updated to version ${{ steps.version.outputs.version }}" || echo "No changes to commit"
          git push origin main

      - name: Create Git tag
        if: ${{ github.event.inputs.dry_run != 'true' }}
        run: |
          git tag -a "v${{ steps.version.outputs.version }}" -m "Release v${{ steps.version.outputs.version }}"
          git push origin "v${{ steps.version.outputs.version }}"

      - name: Setup pub.dev credentials
        if: ${{ github.event.inputs.dry_run != 'true' }}
        run: |
          mkdir -p ~/.config/dart
          echo '${{ secrets.PUB_CREDENTIALS }}' > ~/.config/dart/pub-credentials.json

      - name: Dry run publish
        if: ${{ github.event.inputs.dry_run == 'true' }}
        run: |
          echo "ðŸ” Dry run mode - checking what would be published..."
          echo ""
          echo "Version: ${{ steps.version.outputs.version }}"
          echo ""
          echo "Packages to publish:"
          melos list --json | jq -r '.[] | "- \(.name)@${{ steps.version.outputs.version }}"'
          echo ""
          echo "Running publish dry-run..."
          melos publish --no-private --dry-run

      - name: Publish to pub.dev
        if: ${{ github.event.inputs.dry_run != 'true' }}
        run: |
          echo "ðŸ“¦ Publishing all packages to pub.dev..."
          echo "Version: ${{ steps.version.outputs.version }}"
          echo ""

          # Publish all packages at once
          # Note: pub.dev has a rate limit of 12 packages per 24h rolling window
          # If you have more than 12 packages, you may need to split the publishing
          melos publish --no-private --no-dry-run -y

      - name: Create GitHub Release
        if: ${{ github.event.inputs.dry_run != 'true' }}
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.version.outputs.version }}
          name: Release v${{ steps.version.outputs.version }}
          body_path: RELEASE_NOTES.md
          draft: false
          prerelease: false
          generate_release_notes: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Summary
        run: |
          echo "## ðŸš€ Release Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** v${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Bump Type:** ${{ github.event.inputs.version_type }}" >> $GITHUB_STEP_SUMMARY
          echo "**Dry Run:** ${{ github.event.inputs.dry_run }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ github.event.inputs.dry_run }}" == "true" ]; then
            echo "âš ï¸ **This was a dry run. No packages were published.**" >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… **All packages published with synchronized version!**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Published Packages (All v${{ steps.version.outputs.version }})" >> $GITHUB_STEP_SUMMARY
            melos list --json | jq -r '.[] | "- [\(.name)](https://pub.dev/packages/\(.name))"' >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âš ï¸ **Note:** If you have 36+ packages, pub.dev rate limit (12/24h) may apply." >> $GITHUB_STEP_SUMMARY
            echo "You may need to wait and transfer remaining packages manually." >> $GITHUB_STEP_SUMMARY
          fi

      - name: Post-release instructions
        if: ${{ github.event.inputs.dry_run != 'true' }}
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“‹ Post-Release Checklist" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- [ ] Verify packages on [pub.dev](https://pub.dev/publishers/gsmlg.dev/packages)" >> $GITHUB_STEP_SUMMARY
          echo "- [ ] Transfer new packages to gsmlg.dev publisher" >> $GITHUB_STEP_SUMMARY
          echo "- [ ] Test installation: \`flutter pub add data_visualization:^${{ steps.version.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- [ ] Update demo site if needed" >> $GITHUB_STEP_SUMMARY
          echo "- [ ] Announce release" >> $GITHUB_STEP_SUMMARY

name: Release

on:
  workflow_dispatch:
    inputs:
      version_type:
        description: 'Version bump type'
        required: true
        default: 'patch'
        type: choice
        options:
          - patch
          - minor
          - major
      dry_run:
        description: 'Dry run (skip publish and GitHub release)'
        required: false
        default: false
        type: boolean

permissions:
  contents: write
  id-token: write

jobs:
  release:
    name: Release packages
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable

      - name: Setup Dart
        uses: dart-lang/setup-dart@v1

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.pub-cache
            .dart_tool
          key: ${{ runner.os }}-pub-${{ hashFiles('**/pubspec.lock') }}
          restore-keys: ${{ runner.os }}-pub-

      - name: Install Melos
        run: dart pub global activate melos

      - name: Bootstrap workspace
        run: melos bootstrap

      - name: Run tests
        run: melos run test

      - name: Run analysis
        run: melos run analyze

      - name: Bump versions
        id: version
        run: |
          echo "Bumping ${{ github.event.inputs.version_type }} version..."
          melos version --yes --no-git-tag-version ${{ github.event.inputs.version_type }}

          # Get new version from main package
          VERSION=$(grep "^version:" packages/data_visualization/pubspec.yaml | sed 's/version: //')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "New version: $VERSION"

      - name: Generate changelog
        id: changelog
        run: |
          # Create release notes from recent commits
          cat > RELEASE_NOTES.md << 'EOF'
          ## What's Changed

          EOF

          # Get commits since last tag
          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          if [ -n "$LAST_TAG" ]; then
            git log ${LAST_TAG}..HEAD --pretty=format:"* %s (%h)" >> RELEASE_NOTES.md
          else
            git log --pretty=format:"* %s (%h)" --max-count=50 >> RELEASE_NOTES.md
          fi

          cat >> RELEASE_NOTES.md << 'EOF'

          ## Published Packages

          All packages in this monorepo have been published to pub.dev:

          - **data_visualization** - Umbrella package (includes all packages)
          - **35+ individual packages** - Core utilities, scales, shapes, geographic, hierarchical, charts, and more

          See [README.md](https://github.com/gsmlg-dev/data_visualization/blob/main/README.md) for full package list.

          ## Installation

          \`\`\`yaml
          dependencies:
            data_visualization: ^${{ steps.version.outputs.version }}
          \`\`\`

          ## Resources

          - ðŸ“Š [Live Demo](https://gsmlg-app.github.io/data_visualization/)
          - ðŸ“– [Documentation](https://pub.dev/packages/data_visualization)
          - ðŸ’» [GitHub](https://github.com/gsmlg-dev/data_visualization)
          EOF

          echo "Release notes generated:"
          cat RELEASE_NOTES.md

      - name: Commit version changes
        if: ${{ github.event.inputs.dry_run != 'true' }}
        run: |
          git add .
          git commit -m "chore(release): publish packages v${{ steps.version.outputs.version }}" || echo "No changes to commit"
          git push origin main

      - name: Create Git tag
        if: ${{ github.event.inputs.dry_run != 'true' }}
        run: |
          git tag -a "v${{ steps.version.outputs.version }}" -m "Release v${{ steps.version.outputs.version }}"
          git push origin "v${{ steps.version.outputs.version }}"

      - name: Setup pub.dev credentials
        if: ${{ github.event.inputs.dry_run != 'true' }}
        run: |
          mkdir -p ~/.config/dart
          echo '${{ secrets.PUB_CREDENTIALS }}' > ~/.config/dart/pub-credentials.json

      - name: Dry run publish
        if: ${{ github.event.inputs.dry_run == 'true' }}
        run: |
          echo "ðŸ” Dry run mode - checking what would be published..."
          melos publish --no-private --dry-run

      - name: Publish to pub.dev
        if: ${{ github.event.inputs.dry_run != 'true' }}
        run: |
          echo "ðŸ“¦ Publishing packages to pub.dev..."
          melos publish --no-private --no-dry-run -y

      - name: Create GitHub Release
        if: ${{ github.event.inputs.dry_run != 'true' }}
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.version.outputs.version }}
          name: Release v${{ steps.version.outputs.version }}
          body_path: RELEASE_NOTES.md
          draft: false
          prerelease: false
          generate_release_notes: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Summary
        run: |
          echo "## ðŸš€ Release Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** v${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Bump Type:** ${{ github.event.inputs.version_type }}" >> $GITHUB_STEP_SUMMARY
          echo "**Dry Run:** ${{ github.event.inputs.dry_run }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ github.event.inputs.dry_run }}" == "true" ]; then
            echo "âš ï¸ **This was a dry run. No packages were published.**" >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… **Packages published successfully!**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Published Packages" >> $GITHUB_STEP_SUMMARY
            melos list --json | jq -r '.[] | "- [\(.name)@\(.version)](https://pub.dev/packages/\(.name))"' >> $GITHUB_STEP_SUMMARY
          fi
